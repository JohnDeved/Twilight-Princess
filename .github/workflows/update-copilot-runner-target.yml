name: Update Copilot Runner Target

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"
  push:
    paths:
      - .github/workflows/update-copilot-runner-target.yml

jobs:
  update-target:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Ensure PAT token is configured
        if: ${{ secrets.PAT_TOKEN == '' }}
        run: |
          echo "Missing required secret PAT_TOKEN."
          echo "Create a PAT with repo/actions permissions and store it as PAT_TOKEN."
          exit 1

      - name: Select best runner target for Copilot setup
        if: ${{ secrets.PAT_TOKEN != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const name = "COPILOT_SETUP_RUNS_ON_JSON";

            const runners = await github.paginate(
              github.rest.actions.listSelfHostedRunnersForRepo,
              { owner, repo, per_page: 100 }
            );

            const winRunnerOnline = runners.some(
              (r) => r.name === "runner-win-amd" && r.status === "online" && !r.busy
            );

            const value = winRunnerOnline
              ? '["self-hosted","Windows","X64","runner-win-amd"]'
              : '"ubuntu-latest"';

            try {
              await github.rest.actions.updateRepoVariable({
                owner,
                repo,
                name,
                value,
              });
              core.info(`Updated ${name}=${value}`);
            } catch (error) {
              if (error.status === 404) {
                await github.rest.actions.createRepoVariable({
                  owner,
                  repo,
                  name,
                  value,
                });
                core.info(`Created ${name}=${value}`);
              } else {
                throw error;
              }
            }
