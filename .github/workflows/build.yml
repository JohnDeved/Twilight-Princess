name: Build ISO/RVZ

on:
  push:
  workflow_dispatch:
    inputs:
      debug_incremental:
        description: "Run ninja with -d explain"
        required: false
        default: false
        type: boolean

concurrency:
  group: build-rvz-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        version: [GZ2E01, GZ2P01]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y ninja-build gh libegl1
          python3 -m pip install --upgrade pip
          python3 -m pip install pyisotools==2.4.7

      - name: Cache source disc image
        uses: actions/cache@v4
        with:
          path: orig/${{ matrix.version }}/${{ matrix.version }}.rvz
          key: rom-${{ matrix.version }}-v3

      - name: Cache toolchains and tools
        uses: actions/cache@v4
        with:
          path: |
            build/tools
            build/compilers
            build/binutils
          key: toolchain-${{ runner.os }}-v2
          restore-keys: |
            toolchain-${{ runner.os }}-v1
            toolchain-${{ runner.os }}-

      - name: Cache build outputs
        id: cache-build
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.version }}
            !build/${{ matrix.version }}/*.iso
            !build/${{ matrix.version }}/*.rvz
            !build/${{ matrix.version }}/RELS_work
            !build/${{ matrix.version }}/RELS_work/**
            build.ninja
            objdiff.json
            .ninja_deps
            .ninja_log
          key: build-${{ runner.os }}-${{ matrix.version }}-${{ github.sha }}-${{ hashFiles('configure.py', 'build_iso.sh', 'tools/project.py', 'tools/rarc_pack.py', 'tools/normalize_cache_mtime.py', '.github/workflows/build.yml') }}
          restore-keys: |
            build-${{ runner.os }}-${{ matrix.version }}-

      - name: Ensure source image is available
        env:
          ROMS_TOKEN: ${{ secrets.ROMS_TOKEN }}
        run: |
          if [ -f "orig/${{ matrix.version }}/game.iso" ] || compgen -G "orig/${{ matrix.version }}/*.rvz" >/dev/null || compgen -G "orig/${{ matrix.version }}/*.iso" >/dev/null || compgen -G "orig/${{ matrix.version }}/*.gcm" >/dev/null; then
            echo "Source image already present"
          else
            if [ -z "${ROMS_TOKEN:-}" ]; then
              echo "ERROR: ROMS_TOKEN is not configured; cannot access source release."
              echo "Add repo secret ROMS_TOKEN (PAT with release read access)."
              exit 1
            fi
            export GH_TOKEN="$ROMS_TOKEN"
            mkdir -p orig/${{ matrix.version }}
            gh release view roms --repo ${{ github.repository }} >/dev/null
            gh release download roms \
              --repo ${{ github.repository }} \
              --pattern "${{ matrix.version }}.rvz" \
              --dir orig/${{ matrix.version }}
          fi

      - name: Restore source mtimes for incremental ninja
        run: python3 tools/restore_mtime.py

      - name: Normalize cache mtimes for toolchain inputs
        run: python3 tools/normalize_cache_mtime.py --version ${{ matrix.version }}

      - name: Build RVZ artifact
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.debug_incremental) }}
        run: |
          if [ "${{ steps.cache-build.outputs.cache-hit }}" = "true" ] && [ -f build.ninja ]; then
            echo "Exact cache hit: skipping compile graph"
            ./build_iso.sh --version ${{ matrix.version }} --setup --no-build
            ISO_PATH="build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.iso"
            RVZ_PATH="build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.rvz"
            if [ ! -f "$RVZ_PATH" ] || [ "$ISO_PATH" -nt "$RVZ_PATH" ]; then
              mkdir -p build/tools
              if [ ! -f build/tools/nodtool ]; then
                python3 tools/download_tool.py nodtool build/tools/nodtool --tag v2.0.0-alpha.4
              fi
              build/tools/nodtool convert "$ISO_PATH" "$RVZ_PATH"
            else
              echo "RVZ already up to date"
            fi
          else
            python3 configure.py --version ${{ matrix.version }} --no-check
            ./build_iso.sh --version ${{ matrix.version }} --setup
            ninja rvz
          fi

      - name: Build RVZ artifact (debug explain)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_incremental }}
        run: |
          if [ "${{ steps.cache-build.outputs.cache-hit }}" != "true" ] || [ ! -f build.ninja ]; then
            python3 configure.py --version ${{ matrix.version }} --no-check
          else
            echo "Using cached build.ninja/config artifacts"
          fi
          ./build_iso.sh --version ${{ matrix.version }} --setup
          ninja -d explain rvz

      - name: Upload RVZ artifact
        uses: actions/upload-artifact@v4
        with:
          name: TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}
          path: build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.rvz
          if-no-files-found: error
          compression-level: 0
