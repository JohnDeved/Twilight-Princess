name: Build ISO/RVZ

on:
  push:
    branches:
      - main
    branches-ignore:
      - 'port'
      - 'copilot/**'
  workflow_dispatch:
    inputs:
      debug_incremental:
        description: "Run ninja with -d explain"
        required: false
        default: false
        type: boolean

concurrency:
  group: build-rvz-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        version: [GZ2E01, GZ2P01]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: .github/requirements-ci.txt

      - name: Install dependencies
        run: |
          NEED_APT=0
          command -v ninja >/dev/null || NEED_APT=1
          command -v gh >/dev/null || NEED_APT=1
          ldconfig -p | grep -q 'libEGL.so.1' || NEED_APT=1

          if [ "$NEED_APT" -eq 1 ]; then
            sudo apt-get update -q
            PKGS=()
            command -v ninja >/dev/null || PKGS+=(ninja-build)
            command -v gh >/dev/null || PKGS+=(gh)
            ldconfig -p | grep -q 'libEGL.so.1' || PKGS+=(libegl1)
            if [ "${#PKGS[@]}" -gt 0 ]; then
              sudo apt-get install -y "${PKGS[@]}"
            fi
          fi

          python3 -m pip install --disable-pip-version-check -r .github/requirements-ci.txt

      - name: Cache source disc image
        uses: actions/cache@v4
        with:
          path: orig/${{ matrix.version }}/${{ matrix.version }}.rvz
          key: rom-${{ matrix.version }}-v3

      - name: Cache toolchains and tools
        uses: actions/cache@v4
        with:
          path: |
            build/tools
            build/compilers
            build/binutils
          key: toolchain-${{ runner.os }}-v2
          restore-keys: |
            toolchain-${{ runner.os }}-v1
            toolchain-${{ runner.os }}-

      - name: Cache build outputs
        id: cache-build
        uses: actions/cache@v4
        with:
          path: |
            build/${{ matrix.version }}
            !build/${{ matrix.version }}/*.iso
            !build/${{ matrix.version }}/*.rvz
            !build/${{ matrix.version }}/RELS_work
            !build/${{ matrix.version }}/RELS_work/**
            build.ninja
            objdiff.json
            .ninja_deps
            .ninja_log
          key: build-${{ runner.os }}-${{ matrix.version }}-${{ hashFiles('configure.py', 'build_iso.sh', 'tools/project.py', 'tools/rarc_pack.py', 'tools/normalize_cache_mtime.py', '.github/workflows/build.yml') }}
          restore-keys: |
            build-${{ runner.os }}-${{ matrix.version }}-

      - name: Ensure source image is available
        env:
          ROMS_TOKEN: ${{ secrets.ROMS_TOKEN }}
        run: |
          if [ -f "orig/${{ matrix.version }}/game.iso" ] || compgen -G "orig/${{ matrix.version }}/*.rvz" >/dev/null || compgen -G "orig/${{ matrix.version }}/*.iso" >/dev/null || compgen -G "orig/${{ matrix.version }}/*.gcm" >/dev/null; then
            echo "Source image already present"
          else
            if [ -z "${ROMS_TOKEN:-}" ]; then
              echo "ERROR: ROMS_TOKEN is not configured; cannot access source release."
              echo "Add repo secret ROMS_TOKEN (PAT with release read access)."
              exit 1
            fi
            export GH_TOKEN="$ROMS_TOKEN"
            mkdir -p orig/${{ matrix.version }}
            gh release view roms --repo ${{ github.repository }} >/dev/null
            gh release download roms \
              --repo ${{ github.repository }} \
              --pattern "${{ matrix.version }}.rvz" \
              --dir orig/${{ matrix.version }}
          fi

      - name: Restore source mtimes for incremental ninja
        run: python3 tools/restore_mtime.py

      - name: Normalize cache mtimes for toolchain inputs
        run: python3 tools/normalize_cache_mtime.py --version ${{ matrix.version }}

      - name: Build RVZ artifact
        if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.debug_incremental) }}
        run: |
          GRAPH_SIG="${{ hashFiles('configure.py', 'tools/project.py') }}"
          GRAPH_SIG_FILE="build/${{ matrix.version }}/.ci_graph_sig"
          SOURCE_SHA_FILE="build/${{ matrix.version }}/.ci_source_sha"
          CACHED_GRAPH_SIG=""
          CACHED_SOURCE_SHA=""
          if [ -f "$GRAPH_SIG_FILE" ]; then
            CACHED_GRAPH_SIG="$(cat "$GRAPH_SIG_FILE")"
          fi
          if [ -f "$SOURCE_SHA_FILE" ]; then
            CACHED_SOURCE_SHA="$(cat "$SOURCE_SHA_FILE")"
          fi

          if [ -f build.ninja ] && [ "$CACHED_GRAPH_SIG" = "$GRAPH_SIG" ] && [ "$CACHED_SOURCE_SHA" = "${GITHUB_SHA}" ]; then
            echo "Exact cache hit: skipping compile graph"
            ./build_iso.sh --version ${{ matrix.version }} --setup --no-build
            ISO_PATH="build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.iso"
            RVZ_PATH="build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.rvz"
            if [ ! -f "$RVZ_PATH" ] || [ "$ISO_PATH" -nt "$RVZ_PATH" ]; then
              mkdir -p build/tools
              if [ ! -f build/tools/nodtool ]; then
                python3 tools/download_tool.py nodtool build/tools/nodtool --tag v2.0.0-alpha.4
              fi
              build/tools/nodtool convert "$ISO_PATH" "$RVZ_PATH"
            else
              echo "RVZ already up to date"
            fi
            printf "%s\n" "$GRAPH_SIG" > "$GRAPH_SIG_FILE"
            printf "%s\n" "${GITHUB_SHA}" > "$SOURCE_SHA_FILE"
          else
            if [ ! -f build.ninja ] || [ "$CACHED_GRAPH_SIG" != "$GRAPH_SIG" ]; then
              python3 configure.py --version ${{ matrix.version }} --no-check
            else
              echo "Skipping configure; using cached build graph"
            fi
            ./build_iso.sh --version ${{ matrix.version }} --setup
            ninja rvz
            printf "%s\n" "$GRAPH_SIG" > "$GRAPH_SIG_FILE"
            printf "%s\n" "${GITHUB_SHA}" > "$SOURCE_SHA_FILE"
          fi

      - name: Build RVZ artifact (debug explain)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_incremental }}
        run: |
          GRAPH_SIG="${{ hashFiles('configure.py', 'tools/project.py') }}"
          GRAPH_SIG_FILE="build/${{ matrix.version }}/.ci_graph_sig"
          CACHED_GRAPH_SIG=""
          if [ -f "$GRAPH_SIG_FILE" ]; then
            CACHED_GRAPH_SIG="$(cat "$GRAPH_SIG_FILE")"
          fi

          if [ ! -f build.ninja ] || [ "$CACHED_GRAPH_SIG" != "$GRAPH_SIG" ]; then
            python3 configure.py --version ${{ matrix.version }} --no-check
          else
            echo "Using cached build graph"
          fi
          ./build_iso.sh --version ${{ matrix.version }} --setup
          ninja -d explain rvz

      - name: Upload RVZ artifact
        uses: actions/upload-artifact@v4
        with:
          name: TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}
          path: build/${{ matrix.version }}/TheLegendOfZeldaTwilightPrincess_${{ matrix.version }}.rvz
          if-no-files-found: error
          compression-level: 0
